#!/bin/bash
# PhantomVault command line interface

INSTALL_DIR="/opt/phantomvault"
SERVICE_BIN="$INSTALL_DIR/bin/phantomvault-service"

# Function to check if service is running
is_service_running() {
    systemctl is-active --quiet phantomvault 2>/dev/null
}

# Function to get service status
get_service_status() {
    if is_service_running; then
        echo "✅ Running"
        if command -v ps &> /dev/null && pgrep -f "phantomvault-service" > /dev/null; then
            local memory=$(ps -o rss= -p $(pgrep -f phantomvault-service) 2>/dev/null | awk '{print $1/1024 " MB"}')
            echo "Memory: ${memory:-"Unknown"}"
        fi
    else
        echo "❌ Not running"
    fi
}

# If no arguments, show status
if [[ $# -eq 0 ]]; then
    echo "PhantomVault - Invisible Folder Security"
    echo "========================================"
    echo "Status: $(get_service_status)"
    echo ""
    
    if is_service_running; then
        echo "Quick Actions:"
        echo "• Press Ctrl+Alt+V to access folders"
        echo "• phantomvault --gui to open desktop app"
        echo "• phantomvault --help for more options"
    else
        echo "Service is not running."
        echo "Start with: sudo systemctl start phantomvault"
        echo "Or check installation: phantomvault --status"
    fi
    exit 0
fi

# Handle special arguments
case "$1" in
    --gui)
        exec "$INSTALL_DIR/bin/phantomvault-gui"
        ;;
    --status)
        echo "Service Status:"
        systemctl status phantomvault --no-pager -l
        ;;
    --logs)
        echo "PhantomVault Logs (press Ctrl+C to exit):"
        journalctl -u phantomvault -f --no-pager
        ;;
    --start)
        echo "Starting PhantomVault service..."
        if pkexec systemctl start phantomvault; then
            echo "Service started successfully"
        else
            echo "Failed to start service"
            exit 1
        fi
        ;;
    --stop)
        echo "Stopping PhantomVault service..."
        if pkexec systemctl stop phantomvault; then
            echo "Service stopped successfully"
        else
            echo "Failed to stop service"
            exit 1
        fi
        ;;
    --restart)
        echo "Restarting PhantomVault service..."
        if pkexec systemctl restart phantomvault; then
            echo "Service restarted successfully"
        else
            echo "Failed to restart service"
            exit 1
        fi
        ;;
    --help|-h)
        echo "PhantomVault - Invisible Folder Security"
        echo "========================================"
        echo ""
        echo "Usage: phantomvault [OPTION]"
        echo ""
        echo "Options:"
        echo "  (no args)     Show service status"
        echo "  --gui         Open graphical interface"
        echo "  --status      Show detailed service status"
        echo "  --logs        Show service logs (live)"
        echo "  --start       Start the service"
        echo "  --stop        Stop the service"
        echo "  --restart     Restart the service"
        echo "  --help, -h    Show this help message"
        echo ""
        echo "Service Options (passed to phantomvault-service):"
        echo "  --version     Show service version"
        echo ""
        echo "Examples:"
        echo "  phantomvault              # Show status"
        echo "  phantomvault --gui        # Open GUI"
        echo "  phantomvault --start      # Start service"
        echo "  phantomvault --logs       # View logs"
        ;;
    *)
        # Pass all other arguments to service binary
        if [[ -x "$SERVICE_BIN" ]]; then
            exec "$SERVICE_BIN" "$@"
        else
            echo "PhantomVault service binary not found at $SERVICE_BIN"
            echo "Please check your installation"
            exit 1
        fi
        ;;
esac